/***************************************************************************************************
 * hmi_ecu_appl.c
 * 		Application Software for System Human-Interface ECU.
 * 			- Controlling LCD Display
 * 			- Controlling Keypad 3x4
 * 			- Controlling Input Buttons
 * 			- Send needed Data for Control-ECU through UART
 *
 *  Created on: Sep 29, 2020
 *      Author: Ahmed Montasser
 **************************************************************************************************/



/* Preprocessor Section ***************************************************************************/
#include "DIO.h"
#include "external_interrupt.h"
//#include "UART.h"
#include "LCD.h"
#include "keypad.h"


/* Application S/W #defines */
#define FOREVER                       0x01

#define ENTER_BUTTON                  PA7

/* Table of defined Communication Messages between the two ECUs */
#define UART_READY	                  0xFF

//Received Messages from HMI-ECU:-
#define SETUP_NEW_PASSWORD		      0x01
#define CHANGE_PASSWORD			      0x02
#define CHECK_LOGIN_CREDENTIALS	      0x03
#define OPEN_DOOR				      0x04
#define CLOSE_DOOR				      0x05

//Replies Sent to HMI-ECU:-
#define PASSWORD_SAVED			      0x11
#define USER_AUTHENTICATED            0x12
#define PASSWORD_NOT_MATCHED	      0x21
/**************************************************************************************************/



/* Global Variables *******************************************************************************/
uint8 tx_password[13];
uint8 user_authenticated_flag = TRUE;
/**************************************************************************************************/



/* Functions Declaration **************************************************************************/
void DLS_hardwarePeripheralInit(void);
void DLS_systemWelcome_setupNewPassword(void);
void DLS_userLogin(void);
void DLS_INT0_ISR_callBackFunction_CloseDoorButton(void);
void DLS_INT1_ISR_callBackFunction_OpenDoorButton(void);
/**************************************************************************************************/



/* APPL Software: MAIN FUNCTION *******************************************************************/
int main(void)
{
    uint8 pressed_key;
//    uint8 lcd_message_1[16] = "Select Option:-";
//    uint8 lcd_message_2[32] = "[*]Change Passwd [#]User Authen";
//    uint8 lcd_message_3[9]  = "Success!";
//    uint8 lcd_message_4[6]  = "Fail!";

    user_authenticated_flag = TRUE;

    /* Hardware Peripherals init Functions */
    DLS_hardwarePeripheralInit();

    /* System Welcome and 1st time Password Setup Function */
   do   
   {
       DLS_systemWelcome_setupNewPassword();   
   }
   while(FALSE);
    

    while(FOREVER)
    {
        pressed_key = _KEYPAD_getCurrentPressedKey();

        switch( pressed_key )
        {
        case '#':   /*Key for User Login*/
                DLS_userLogin();
            break;

        case '*':   /*Key for Change Password*/

            break;
            
        default:
            /*Do Nothing*/
            break;
        }

    }
    
    return 0;

}

/* APPL Software: MAIN FUNCTION *******************************************************************/
void  DLS_hardwarePeripheralInit(void)
{
    /* Initialize LCD Hardware */
    _LCD_init();

    /* Initialize ENTER Button: Digital Output Pin */
    __DIO_setPinDirection(DDR_A, ENTER_BUTTON, INPUT_PIN);
    __DIO_enableInternalPullupResistance(PORT_A, ENTER_BUTTON);

    /* Initialize Open/Close Door Buttons; External Interrupt */
    __INT0_init(FALLING_EDGE, EN_PULLUP);
    __INT1_init(FALLING_EDGE, EN_PULLUP);
    __INT0_setISRCallBackFuncPointer(DLS_INT0_ISR_callBackFunction_CloseDoorButton);
    __INT1_setISRCallBackFuncPointer(DLS_INT1_ISR_callBackFunction_OpenDoorButton);

    /*TESTING*/__DIO_setPinDirection(DDR_C, PC7, OUTPUT_PIN);/*TESTING*/
    /*TESTING*/__DIO_writeOutputPinValue(PORT_C, PC7, LOW);/*TESTING*/
}
/**************************************************************************************************/

/* APPL Software: MAIN FUNCTION *******************************************************************/
void DLS_systemWelcome_setupNewPassword(void)
{
    uint8 passwd_length = 0;
    uint8 lcd_message_1[17] = "-Welcome to DLS-";
    uint8 lcd_message_2[15] = "Enter Passwd: ";
    uint8 lcd_message_3[4]  = "Re-";
    uint8 lcd_message_4[8]  = "SUBMIT?";
    uint8 lcd_message_5[17] = "Saving Passwd...";


    /* Display the Welcome Message */
    _LCD_adjustCursorPosition(0, 8);
    _LCD_displayString(lcd_message_1);
    APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;
    //APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;


    /* Fill the Password Entries 1st time */
    _LCD_adjustCursorPosition(1,0);
    _LCD_displayString(lcd_message_2);
    while(FOREVER)
    {

        /* Check if the password reach maximum length */
        if( passwd_length == 4 )
        {
            _LCD_displayString_atCursor(lcd_message_4, 1, 25);
            while( __DIO_readInputPinValue(PIN_A, PA7)==HIGH );
            break;
        }

        /* Delay; in order not to receive multiple values from one press */
        APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;

        /* Get pressed key value and save it in tx_password array */
        tx_password[passwd_length] = _KEYPAD_getCurrentPressedKey();

        /* if pressed key not a number; do nothing and overwrite this value */
        if( tx_password[passwd_length]>='0' && tx_password[passwd_length]<='9' )
        {
            _LCD_displayCharacter(tx_password[passwd_length]);
            passwd_length++;
        }
    }


    /* Fill the Password Entries 2nd time */
    _LCD_clearScreen();APPROX_HALF_SEC_DELAY;
    _LCD_adjustCursorPosition(0, 8);
    _LCD_displayString(lcd_message_1);
    _LCD_adjustCursorPosition(1,0);
    _LCD_displayString(lcd_message_3);_LCD_displayString(lcd_message_2);
    while(FOREVER)
    {

        /* Check if the password reach maximum length */
        if( passwd_length == 8 )
        {
            tx_password[passwd_length] = '\0';
            _LCD_displayString_atCursor(lcd_message_4, 1, 25);
            while( __DIO_readInputPinValue(PIN_A, PA7)==HIGH );
            break;
        }

        /* Delay; in order not to receive multiple values from one press */
        APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;

        /* Get pressed key value and save it in tx_password array */
        tx_password[passwd_length] = _KEYPAD_getCurrentPressedKey();

        /* if pressed key not a number; do nothing and overwrite this value */
        if( tx_password[passwd_length]>='0' && tx_password[passwd_length]<='9' )
        {
            _LCD_displayCharacter(tx_password[passwd_length]);
            passwd_length++;
        }
    }

    /* Output Saving Password and return to Main Function */
    _LCD_clearScreen();APPROX_HALF_SEC_DELAY;
    _LCD_displayString(lcd_message_5);
    _LCD_displayString(tx_password);
}
/**************************************************************************************************/

/* APPL Software: MAIN FUNCTION *******************************************************************/
void DLS_userLogin(void)
{
    uint8 passwd_length = 0;
    uint8 lcd_message_1[13] = "User Login:-";
    uint8 lcd_message_2[15] = "Enter Passwd: ";
    uint8 lcd_message_3[8]  = "SUBMIT?";
    uint8 lcd_message_4[9]  = "Login...";


    /* Display the Welcome Message */
    _LCD_clearScreen();
    APPROX_HALF_SEC_DELAY;
    _LCD_displayString(lcd_message_1);
    APPROX_HALF_SEC_DELAY;


    /* Fill the Password Entries */
    _LCD_adjustCursorPosition(1,0);
    _LCD_displayString(lcd_message_2);
    while(FOREVER)
    {

        if( passwd_length == 4 )
        {
            tx_password[passwd_length] = '\0';
            _LCD_displayString_atCursor(lcd_message_3, 1, 25);
            while( __DIO_readInputPinValue(PIN_A, PA7) == HIGH );
            break;
        }

        /* Delay; in order not to receive multiple values from one press */
        APPROX_1SEC_DELAY;APPROX_1SEC_DELAY;

        /* Get pressed key value and save it in tx_password array */
        tx_password[passwd_length] = _KEYPAD_getCurrentPressedKey();

        /* if pressed key not a number; do nothing and overwrite this value */
        if( tx_password[passwd_length]>='0' && tx_password[passwd_length]<='9' )
        {
            _LCD_displayCharacter(tx_password[passwd_length]);
            passwd_length++;
        }

    }

    /* Output Saving Password and return to Main Function */
    _LCD_clearScreen();
    APPROX_HALF_SEC_DELAY;
    _LCD_adjustCursorPosition(1,0);
    _LCD_displayString(lcd_message_4);
    _LCD_displayString(tx_password);
}
/**************************************************************************************************/

/* APPL Software: MAIN FUNCTION *******************************************************************/
/**************************************************************************************************/

/* APPL Software: MAIN FUNCTION *******************************************************************/
void DLS_INT0_ISR_callBackFunction_CloseDoorButton(void)
{
    __DIO_writeOutputPinValue(PORT_C, PC7, HIGH);
    if( user_authenticated_flag )
    {
        __DIO_writeOutputPinValue(PORT_C, PC7, HIGH);
    }
}
/**************************************************************************************************/

/* APPL Software: MAIN FUNCTION *******************************************************************/
void DLS_INT1_ISR_callBackFunction_OpenDoorButton(void)
{
    if( user_authenticated_flag )
    {
        __DIO_writeOutputPinValue(PORT_C, PC7, LOW);
    }
}
/**************************************************************************************************/
